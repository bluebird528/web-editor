#!/bin/sh
#
# prepare-commit-msg hook
# 커밋 메시지를 자동으로 생성하거나 템플릿을 로드합니다.
#

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA1=$3

# merge, squash, amend 등의 경우 자동 생성하지 않음
if [ -n "$COMMIT_SOURCE" ]; then
    exit 0
fi

# 현재 디렉토리 저장
HOOK_DIR=$(dirname "$0")
SCRIPT_DIR="$HOOK_DIR/../../scripts/git-hooks"

# 커밋 메시지 파일이 비어있거나 기본 메시지만 있는 경우
if [ ! -s "$COMMIT_MSG_FILE" ] || grep -q "^# Please enter the commit message" "$COMMIT_MSG_FILE"; then
    # 자동 커밋 메시지 생성 시도
    if [ -x "$SCRIPT_DIR/generate-commit-msg.sh" ]; then
        AUTO_MSG=$("$SCRIPT_DIR/generate-commit-msg.sh")

        if [ -n "$AUTO_MSG" ] && [ "$AUTO_MSG" != "" ]; then
            # 자동 생성된 메시지를 파일 상단에 추가
            echo "$AUTO_MSG" > "$COMMIT_MSG_FILE"
            echo "" >> "$COMMIT_MSG_FILE"
            echo "# 위의 자동 생성된 커밋 메시지를 수정하거나 아래 템플릿을 참고하세요" >> "$COMMIT_MSG_FILE"
            echo "#" >> "$COMMIT_MSG_FILE"

            # 템플릿 내용 추가 (주석 처리)
            if [ -f ".gitmessage" ]; then
                cat .gitmessage | sed 's/^/# /' >> "$COMMIT_MSG_FILE"
            fi

            exit 0
        fi
    fi

    # 자동 생성 실패 시 기본 템플릿 사용
    EXISTING_MSG=$(cat "$COMMIT_MSG_FILE" | grep -v "^#" | grep -v "^$")

    if [ -f ".gitmessage" ]; then
        cat .gitmessage > "$COMMIT_MSG_FILE"

        if [ -n "$EXISTING_MSG" ]; then
            echo "$EXISTING_MSG" | cat - "$COMMIT_MSG_FILE" > temp && mv temp "$COMMIT_MSG_FILE"
        fi
    fi
fi

exit 0
