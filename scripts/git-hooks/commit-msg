#!/bin/sh
#
# commit-msg hook
# Conventional Commits 형식을 검증합니다.
#

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# 주석 제거 및 공백 라인 제거
COMMIT_MSG_CLEANED=$(echo "$COMMIT_MSG" | grep -v "^#" | grep -v "^$" | head -n 1)

# 빈 커밋 메시지 검사
if [ -z "$COMMIT_MSG_CLEANED" ]; then
    echo "오류: 커밋 메시지가 비어있습니다."
    exit 1
fi

# Conventional Commits 형식 검증
# 형식: <type>(<scope>): <subject> 또는 <type>: <subject>
# type: feat, fix, refactor, style, chore, docs, test, perf, ci
PATTERN="^(feat|fix|refactor|style|chore|docs|test|perf|ci)(\(.+\))?: .{1,}"

if ! echo "$COMMIT_MSG_CLEANED" | grep -qE "$PATTERN"; then
    echo "========================================"
    echo "커밋 메시지 형식 오류"
    echo "========================================"
    echo ""
    echo "Conventional Commits 형식을 따라주세요:"
    echo "  <type>(<scope>): <subject>"
    echo ""
    echo "허용되는 type:"
    echo "  - feat     : 새로운 기능 추가"
    echo "  - fix      : 버그 수정"
    echo "  - refactor : 코드 리팩토링"
    echo "  - style    : 코드 포맷팅"
    echo "  - chore    : 빌드, 설정 파일 등"
    echo "  - docs     : 문서 수정"
    echo "  - test     : 테스트 코드"
    echo "  - perf     : 성능 개선"
    echo "  - ci       : CI/CD 설정"
    echo ""
    echo "예시:"
    echo "  feat(auth): JWT 토큰 갱신 기능 추가"
    echo "  fix(content): 내용 업데이트 시 NPE 수정"
    echo "  docs: README 업데이트"
    echo ""
    echo "현재 커밋 메시지:"
    echo "  $COMMIT_MSG_CLEANED"
    echo "========================================"
    exit 1
fi

# Subject 길이 검증 (50자 권장, 72자 최대)
SUBJECT=$(echo "$COMMIT_MSG_CLEANED" | sed 's/^[^:]*: //')
SUBJECT_LENGTH=${#SUBJECT}

if [ $SUBJECT_LENGTH -gt 72 ]; then
    echo "경고: 커밋 제목이 너무 깁니다 (${SUBJECT_LENGTH}자). 72자 이내로 작성해주세요."
    echo "현재 제목: $SUBJECT"
    exit 1
elif [ $SUBJECT_LENGTH -gt 50 ]; then
    echo "경고: 커밋 제목이 깁니다 (${SUBJECT_LENGTH}자). 50자 이내를 권장합니다."
fi

exit 0
